{% set lens = swap_history.values() | map('length') | list %}
{% set has_history = lens | max > 1 if lens else false %}
{% if has_history %}
<div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider mb-3">Swap-renter siste 90 dager</h2>
    <canvas id="swap-history-chart"></canvas>
</div>
<script>
(function() {
    Chart.defaults.color = '#9ca3af';
    Chart.defaults.borderColor = '#374151';

    const history = {{ swap_history | tojson }};
    const styles = {
        '3 Yr': { color: '#34d399', dash: [],      width: 2.5 },
        '5 Yr': { color: '#60a5fa', dash: [6, 3],  width: 2.5 },
        '10 Yr':{ color: '#a78bfa', dash: [2, 2],  width: 2.5 },
    };

    let allDates = [];
    const dataByTenor = {};
    for (const [tenor, points] of Object.entries(history)) {
        if (points.length < 2) continue;
        const mapped = points.map(p => {
            const d = p.observed_at.split('T')[0];
            const parts = d.split('-');
            return { date: d, label: parts[2] + '.' + parts[1], rate: p.rate };
        });
        dataByTenor[tenor] = mapped;
        if (mapped.length > allDates.length) {
            allDates = mapped.map(m => m.label);
        }
    }

    const datasets = [];
    for (const [tenor, mapped] of Object.entries(dataByTenor)) {
        const s = styles[tenor] || { color: '#9ca3af', dash: [], width: 2 };
        datasets.push({
            label: tenor,
            data: mapped.map(m => m.rate),
            borderColor: s.color,
            backgroundColor: 'transparent',
            borderWidth: s.width,
            borderDash: s.dash,
            pointRadius: 0,
            pointHitRadius: 8,
            tension: 0.3,
        });
    }

    const ctx = document.getElementById('swap-history-chart');
    if (ctx && datasets.length) {
        if (ctx._chartInstance) ctx._chartInstance.destroy();
        const chart = new Chart(ctx, {
            type: 'line',
            data: { labels: allDates, datasets },
            options: {
                responsive: true,
                aspectRatio: 3,
                interaction: { mode: 'index', intersect: false },
                plugins: {
                    legend: {
                        labels: {
                            usePointStyle: true,
                            pointStyle: 'line',
                            boxWidth: 20,
                            font: { size: 11 },
                        },
                    },
                    tooltip: {
                        callbacks: {
                            label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(2) + '%',
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { display: false },
                        ticks: {
                            maxTicksLimit: 12,
                            font: { size: 10 },
                            maxRotation: 45,
                            minRotation: 0,
                        },
                    },
                    y: {
                        grid: { color: '#1f2937' },
                        ticks: {
                            callback: v => v.toFixed(2) + '%',
                            font: { size: 10 },
                        },
                    },
                },
            },
        });
        ctx._chartInstance = chart;
    }
})();
</script>
{% endif %}
