<div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <div class="flex items-center justify-between mb-1">
        <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Bind nå vs vent</h2>
        <span class="text-xs text-gray-500">ved {{ "{:,.0f}".format(loan_amount).replace(",", " ") }} kr</span>
    </div>
    <p class="text-xs text-gray-600 mb-4">Basert på estimert neste Lånekassen-fastrente fra topp-5 banker</p>
    {% if savings %}
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        {% for s in savings %}
        <div class="bg-gray-800/50 rounded-lg p-3">
            <div class="flex items-center justify-between mb-1">
                <p class="text-xs text-gray-500">Fast {{ s.tenor }}</p>
                <span class="text-[10px] px-1.5 py-0.5 rounded-full
                    {% if s.risk == 'lav' %}bg-emerald-900/40 text-emerald-400
                    {% elif s.risk == 'middels' %}bg-yellow-900/40 text-yellow-400
                    {% else %}bg-red-900/40 text-red-400{% endif %}">
                    {{ s.risk }} risiko
                </span>
            </div>
            <p class="text-lg font-mono font-semibold
                {% if s.bind_now %}text-emerald-400{% else %}text-red-400{% endif %}">
                {% if s.bind_now %}Bind nå{% else %}Vent{% endif %}
            </p>
            <p class="text-xs mt-1
                {% if s.bind_now %}text-emerald-400/80{% else %}text-red-400/80{% endif %}">
                {{ "{:+,.0f}".format(s.annual_diff).replace(",", " ") }} kr/år
            </p>
            <p class="text-xs mt-0.5 font-medium
                {% if s.bind_now %}text-emerald-300{% else %}text-red-300{% endif %}">
                {{ "{:+,.0f}".format(s.total_diff).replace(",", " ") }} kr totalt over {{ s.years }} år
            </p>
            <p class="text-xs text-gray-600 mt-1">
                {{ "%.3f"|format(s.fixed_rate) }}% nå vs est. {{ "%.3f"|format(s.estimated_next_rate) }}% neste
            </p>
        </div>
        {% endfor %}
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-gray-800/50 rounded-lg p-4">
            <p class="text-xs text-gray-500 mb-2">Besparelse per tenor (kr)</p>
            <canvas id="savings-bar-chart"></canvas>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-4">
            <p class="text-xs text-gray-500 mb-2">Nåværende vs estimert neste fastrente (%)</p>
            <canvas id="rate-compare-chart"></canvas>
        </div>
    </div>

    <script>
    (function() {
        const chartDefaults = {
            color: '#9ca3af',
            borderColor: '#374151',
        };
        Chart.defaults.color = chartDefaults.color;
        Chart.defaults.borderColor = chartDefaults.borderColor;

        const savings = {{ savings | map(attribute='__dict__') | list | tojson }};
        const tenors = savings.map(s => s.tenor);

        // -- Bar chart: annual + total savings --
        const savingsCtx = document.getElementById('savings-bar-chart');
        if (savingsCtx) {
            // Destroy existing chart on HTMX re-swap
            if (savingsCtx._chartInstance) savingsCtx._chartInstance.destroy();
            const chart = new Chart(savingsCtx, {
                type: 'bar',
                data: {
                    labels: tenors,
                    datasets: [
                        {
                            label: 'Per år',
                            data: savings.map(s => s.annual_diff),
                            backgroundColor: savings.map(s => s.bind_now ? '#34d399' : '#f87171'),
                            borderRadius: 4,
                        },
                        {
                            label: 'Totalt',
                            data: savings.map(s => s.total_diff),
                            backgroundColor: savings.map(s => s.bind_now ? '#059669' : '#dc2626'),
                            borderRadius: 4,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    aspectRatio: 1.8,
                    plugins: {
                        legend: { labels: { boxWidth: 12, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const v = ctx.raw;
                                    return ctx.dataset.label + ': ' + (v >= 0 ? '+' : '') + v.toLocaleString('nb-NO') + ' kr';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#1f2937' },
                            ticks: {
                                callback: v => (v >= 0 ? '+' : '') + v.toLocaleString('nb-NO') + ' kr',
                                font: { size: 10 },
                            },
                        },
                        x: { grid: { display: false } },
                    },
                },
            });
            savingsCtx._chartInstance = chart;
        }

        // -- Grouped bar: current vs estimated rate --
        const rateCtx = document.getElementById('rate-compare-chart');
        if (rateCtx) {
            if (rateCtx._chartInstance) rateCtx._chartInstance.destroy();
            const chart = new Chart(rateCtx, {
                type: 'bar',
                data: {
                    labels: tenors,
                    datasets: [
                        {
                            label: 'Nåværende',
                            data: savings.map(s => s.fixed_rate),
                            backgroundColor: '#60a5fa',
                            borderRadius: 4,
                        },
                        {
                            label: 'Estimert neste',
                            data: savings.map(s => s.estimated_next_rate),
                            backgroundColor: '#a78bfa',
                            borderRadius: 4,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    aspectRatio: 1.8,
                    plugins: {
                        legend: { labels: { boxWidth: 12, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(3) + '%',
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#1f2937' },
                            ticks: {
                                callback: v => v.toFixed(2) + '%',
                                font: { size: 10 },
                            },
                        },
                        x: { grid: { display: false } },
                    },
                },
            });
            rateCtx._chartInstance = chart;
        }
    })();
    </script>
    {% else %}
    <p class="text-gray-500 text-sm">Ingen beregninger tilgjengelig</p>
    {% endif %}
</div>
