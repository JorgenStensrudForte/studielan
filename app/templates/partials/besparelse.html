<div class="bg-gray-900 rounded-xl border border-gray-800 p-5">
    <div class="flex items-center justify-between mb-1">
        <h2 class="text-sm font-semibold text-gray-400 uppercase tracking-wider">Bind nå vs vent</h2>
        <span class="text-xs text-gray-500">ved {{ "{:,.0f}".format(loan_amount).replace(",", " ") }} kr</span>
    </div>
    <p class="text-xs text-gray-600 mb-4">Basert på estimert neste Lånekassen-fastrente fra topp-5 banker (nominell)</p>
    {% if savings %}
    <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
        {% for s in savings %}
        <div class="bg-gray-800/50 rounded-lg p-3 cursor-pointer hover:bg-gray-700/50 transition-colors group"
             onclick="openCalcModal({{ loop.index0 }})">
            <div class="flex items-center justify-between mb-1">
                <p class="text-xs text-gray-500">Fast {{ s.tenor }}</p>
                <span class="text-[10px] px-1.5 py-0.5 rounded-full
                    {% if s.risk == 'lav' %}bg-emerald-900/40 text-emerald-400
                    {% elif s.risk == 'middels' %}bg-yellow-900/40 text-yellow-400
                    {% else %}bg-red-900/40 text-red-400{% endif %}">
                    {{ s.risk }} risiko
                </span>
            </div>
            <p class="text-lg font-mono font-semibold
                {% if s.bind_now %}text-emerald-400{% else %}text-red-400{% endif %}">
                {% if s.bind_now %}Bind nå{% else %}Vent{% endif %}
            </p>
            <p class="text-xs mt-1
                {% if s.bind_now %}text-emerald-400/80{% else %}text-red-400/80{% endif %}">
                {{ "{:+,.0f}".format(s.annual_diff).replace(",", " ") }} kr/år
            </p>
            <p class="text-xs mt-0.5 font-medium
                {% if s.bind_now %}text-emerald-300{% else %}text-red-300{% endif %}">
                {{ "{:+,.0f}".format(s.total_diff).replace(",", " ") }} kr totalt over {{ s.years }} år
            </p>
            <p class="text-xs text-gray-600 mt-1">
                {{ "%.3f"|format(s.fixed_rate) }}% nominell nå vs est. {{ "%.3f"|format(s.estimated_next_rate) }}% nominell neste
            </p>
            <p class="text-[10px] text-gray-600 mt-1.5 opacity-0 group-hover:opacity-100 transition-opacity">Klikk for detaljert utregning</p>
        </div>
        {% endfor %}
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
        <div class="bg-gray-800/50 rounded-lg p-4">
            <p class="text-xs text-gray-500 mb-2">Besparelse per tenor (kr)</p>
            <canvas id="savings-bar-chart"></canvas>
        </div>
        <div class="bg-gray-800/50 rounded-lg p-4">
            <p class="text-xs text-gray-500 mb-2">Nåværende vs estimert neste fastrente (nominell %)</p>
            <canvas id="rate-compare-chart"></canvas>
        </div>
    </div>

    <!-- Chart scripts -->
    <script>
    (function() {
        Chart.defaults.color = '#9ca3af';
        Chart.defaults.borderColor = '#374151';

        const savings = {{ savings | map(attribute='__dict__') | list | tojson }};
        const tenors = savings.map(s => s.tenor);

        const savingsCtx = document.getElementById('savings-bar-chart');
        if (savingsCtx) {
            if (savingsCtx._chartInstance) savingsCtx._chartInstance.destroy();
            const chart = new Chart(savingsCtx, {
                type: 'bar',
                data: {
                    labels: tenors,
                    datasets: [
                        {
                            label: 'Per år',
                            data: savings.map(s => s.annual_diff),
                            backgroundColor: savings.map(s => s.bind_now ? '#34d399' : '#f87171'),
                            borderRadius: 4,
                        },
                        {
                            label: 'Totalt',
                            data: savings.map(s => s.total_diff),
                            backgroundColor: savings.map(s => s.bind_now ? '#059669' : '#dc2626'),
                            borderRadius: 4,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    aspectRatio: 1.8,
                    plugins: {
                        legend: { labels: { boxWidth: 12, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(ctx) {
                                    const v = ctx.raw;
                                    return ctx.dataset.label + ': ' + (v >= 0 ? '+' : '') + v.toLocaleString('nb-NO') + ' kr';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#1f2937' },
                            ticks: {
                                callback: v => (v >= 0 ? '+' : '') + v.toLocaleString('nb-NO') + ' kr',
                                font: { size: 10 },
                            },
                        },
                        x: { grid: { display: false } },
                    },
                },
            });
            savingsCtx._chartInstance = chart;
        }

        const rateCtx = document.getElementById('rate-compare-chart');
        if (rateCtx) {
            if (rateCtx._chartInstance) rateCtx._chartInstance.destroy();
            const chart = new Chart(rateCtx, {
                type: 'bar',
                data: {
                    labels: tenors,
                    datasets: [
                        {
                            label: 'Nåværende',
                            data: savings.map(s => s.fixed_rate),
                            backgroundColor: '#60a5fa',
                            borderRadius: 4,
                        },
                        {
                            label: 'Estimert neste',
                            data: savings.map(s => s.estimated_next_rate),
                            backgroundColor: '#a78bfa',
                            borderRadius: 4,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    aspectRatio: 1.8,
                    plugins: {
                        legend: { labels: { boxWidth: 12, font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: ctx => ctx.dataset.label + ': ' + ctx.raw.toFixed(3) + '%',
                            }
                        }
                    },
                    scales: {
                        y: {
                            grid: { color: '#1f2937' },
                            ticks: {
                                callback: v => v.toFixed(2) + '%',
                                font: { size: 10 },
                            },
                        },
                        x: { grid: { display: false } },
                    },
                },
            });
            rateCtx._chartInstance = chart;
        }
    })();
    </script>

    <!-- Calculation modal -->
    <div id="calc-modal" class="fixed inset-0 z-50 items-center justify-center bg-black/60 backdrop-blur-sm p-4"
         style="display:none"
         onclick="if(event.target===this)closeCalcModal()">
        <div class="bg-gray-900 border border-gray-700 rounded-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto shadow-2xl">
            <div class="sticky top-0 bg-gray-900 border-b border-gray-800 px-5 py-4 flex justify-between items-center rounded-t-2xl z-10">
                <h3 id="modal-title" class="text-base font-bold text-white"></h3>
                <button onclick="closeCalcModal()" class="text-gray-400 hover:text-white text-2xl leading-none px-2">&times;</button>
            </div>
            <div id="modal-body" class="px-5 py-4"></div>
        </div>
    </div>

    <!-- Modal calculation script -->
    <script>
    (function() {
        const savingsData = {{ savings | map(attribute='__dict__') | list | tojson }};
        {% if lanekassen %}
        const floatingRate = {{ lanekassen.floating }};
        {% else %}
        const floatingRate = null;
        {% endif %}
        const estRates = {
            {% for e in estimates %}'{{ e.tenor }}': {{ e.estimated_lk }},
            {% endfor %}
        };

        const remainingLoanYears = {{ remaining_years | default(20) }};

        const LEGACY_WEIGHTS = {
            '3 år': [
                { label: 'Flytende', pct: 0.10 },
                { label: '3 år', pct: 0.70 },
                { label: '5 år', pct: 0.15 },
                { label: '10 år', pct: 0.05 },
            ],
            '5 år': [
                { label: 'Flytende', pct: 0.05 },
                { label: '3 år', pct: 0.15 },
                { label: '5 år', pct: 0.65 },
                { label: '10 år', pct: 0.15 },
            ],
            '10 år': [
                { label: 'Flytende', pct: 0.03 },
                { label: '3 år', pct: 0.07 },
                { label: '5 år', pct: 0.25 },
                { label: '10 år', pct: 0.65 },
            ],
        };

        function rateFor(label) {
            if (label === 'Flytende') return floatingRate || 0;
            return estRates[label] || 0;
        }

        /* Annuitetsformel: A = P × r / (1 − (1+r)^(−n)) */
        function annuity(P, rm, n) {
            if (rm <= 0) return P / n;
            return P * rm / (1 - Math.pow(1 + rm, -n));
        }

        function fmt(v, d) {
            return v.toLocaleString('nb-NO', {
                minimumFractionDigits: d,
                maximumFractionDigits: d,
            });
        }
        function fmtKr(v) { return fmt(Math.round(v), 0) + ' kr'; }
        function sign(v) { return v >= 0 ? '+' : ''; }

        function tenorYears(label) {
            return Number(String(label).replace(' år', '').trim()) || 0;
        }

        function interpolationBracket(remainingBindingYears) {
            if (remainingBindingYears < 3) {
                return { T1: 0, T2: 3, label1: 'Flytende', label2: '3 år' };
            }
            if (remainingBindingYears < 5) {
                return { T1: 3, T2: 5, label1: '3 år', label2: '5 år' };
            }
            return { T1: 5, T2: 10, label1: '5 år', label2: '10 år' };
        }

        function weightedRate(weights) {
            let rate = 0;
            for (const w of weights) {
                rate += w.pct * rateFor(w.label);
            }
            return rate;
        }

        window.openCalcModal = function(idx) {
            const s = savingsData[idx];
            const tenor = s.tenor;

            const P = s.loan_amount;
            const rOld = s.fixed_rate;
            const remainingBindingYears = tenorYears(tenor);
            const n = Math.round(remainingLoanYears * 12);
            const legacyN = Math.max(1, remainingBindingYears * 12 - 2);

            const bracket = interpolationBracket(remainingBindingYears);
            const rT1 = rateFor(bracket.label1);
            const rT2 = rateFor(bracket.label2);
            const w1 = (bracket.T2 - remainingBindingYears) / (bracket.T2 - bracket.T1);
            const w2 = (remainingBindingYears - bracket.T1) / (bracket.T2 - bracket.T1);
            const rNew = rT1 * w1 + rT2 * w2;

            const legacyWeights = LEGACY_WEIGHTS[tenor] || [];
            const rLegacy = weightedRate(legacyWeights);

            const rmOld = rOld / 100 / 12;
            const rmNew = rNew / 100 / 12;
            const rmLegacy = rLegacy / 100 / 12;

            const aOld = annuity(P, rmOld, n);
            const aNew = annuity(P, rmNew, n);
            const deltaA = aNew - aOld;

            const nonDisc = deltaA * n;

            let npv = 0;
            for (let t = 1; t <= n; t++) {
                npv += deltaA / Math.pow(1 + rmNew, t);
            }

            const diffNonDiscNpv = nonDisc - npv;
            const term1 = deltaA / Math.pow(1 + rmNew, 1);
            const term2 = deltaA / Math.pow(1 + rmNew, 2);
            const term3 = deltaA / Math.pow(1 + rmNew, 3);
            const termN = deltaA / Math.pow(1 + rmNew, n);

            const aOldLegacy = annuity(P, rmOld, legacyN);
            const aNewLegacy = annuity(P, rmLegacy, legacyN);
            const deltaLegacy = aNewLegacy - aOldLegacy;
            const nonDiscLegacy = deltaLegacy * legacyN;
            let npvLegacy = 0;
            for (let t = 1; t <= legacyN; t++) {
                npvLegacy += deltaLegacy / Math.pow(1 + rmLegacy, t);
            }

            const npvDeviation = npv - npvLegacy;
            const nonDiscDeviation = nonDisc - nonDiscLegacy;
            const rateDeviation = rNew - rLegacy;
            const monthDeviation = n - legacyN;

            const pos = deltaA > 0;
            const clr = pos ? 'text-emerald-400' : deltaA < 0 ? 'text-red-400' : 'text-gray-300';

            let h = '';

            function row(num, label, val, sub) {
                h += '<div class="flex justify-between items-baseline py-2.5 border-b border-gray-800/50">'
                   + '<span class="text-sm text-gray-300"><span class="text-gray-600 font-mono text-xs mr-2">' + num + '.</span>' + label + '</span>'
                   + '<span class="font-mono text-sm text-white font-medium ml-4 text-right shrink-0">' + val + '</span>'
                   + '</div>';
                if (sub) {
                    h += '<p class="text-[10px] text-gray-600 font-mono py-0.5 break-all">' + sub + '</p>';
                }
            }

            row(1, 'Restgjeld', fmtKr(P));
            row(2, 'Opprinnelig fastrente (binder nå)', fmt(rOld, 3) + ' %');
            row(3, 'Gjenværende bindingstid (T)', fmt(remainingBindingYears, 3) + ' år');

            h += '<div class="py-3 border-b border-gray-800/50">'
               + '<p class="text-sm text-gray-300 mb-2"><span class="text-gray-600 font-mono text-xs mr-2">4.</span>Ny markedsrente (lineær interpolasjon, kun to nærmeste punkter)</p>'
               + '<table class="w-full text-xs"><tbody>'
               + '<tr class="border-b border-gray-800/30">'
               + '<td class="py-1.5 text-gray-400 w-20">T1</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300 w-14">' + fmt(bracket.T1, 3) + ' år</td>'
               + '<td class="py-1.5 text-center text-gray-600 w-6"></td>'
               + '<td class="py-1.5 text-right font-mono text-gray-500 w-20">' + bracket.label1 + '</td>'
               + '<td class="py-1.5 text-center text-gray-600 w-6"></td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300 w-20">' + fmt(rT1, 3) + ' %</td>'
               + '</tr>'
               + '<tr class="border-b border-gray-800/30">'
               + '<td class="py-1.5 text-gray-400 w-20">T2</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300 w-14">' + fmt(bracket.T2, 3) + ' år</td>'
               + '<td class="py-1.5 text-center text-gray-600 w-6"></td>'
               + '<td class="py-1.5 text-right font-mono text-gray-500 w-20">' + bracket.label2 + '</td>'
               + '<td class="py-1.5 text-center text-gray-600 w-6"></td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300 w-20">' + fmt(rT2, 3) + ' %</td>'
               + '</tr>'
               + '<tr class="border-b border-gray-800/30">'
               + '<td class="py-1.5 text-gray-400 w-20">Vekt T1</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300 w-14">' + fmt(w1 * 100, 2) + ' %</td>'
               + '<td class="py-1.5 text-center text-gray-600 w-6">\u00d7</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-500 w-20">' + fmt(rT1, 3) + ' %</td>'
               + '<td class="py-1.5 text-center text-gray-600 w-6">=</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300 w-20">' + fmt(w1 * rT1, 4) + ' %</td>'
               + '</tr>'
               + '<tr class="border-b border-gray-800/30">'
               + '<td class="py-1.5 text-gray-400 w-20">Vekt T2</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300 w-14">' + fmt(w2 * 100, 2) + ' %</td>'
               + '<td class="py-1.5 text-center text-gray-600 w-6">\u00d7</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-500 w-20">' + fmt(rT2, 3) + ' %</td>'
               + '<td class="py-1.5 text-center text-gray-600 w-6">=</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300 w-20">' + fmt(w2 * rT2, 4) + ' %</td>'
               + '</tr>'
               + '<tr class="border-t border-gray-600">'
               + '<td class="py-2 text-gray-200 font-semibold">r<sub>new</sub></td>'
               + '<td class="py-2 text-right font-mono text-white font-semibold">' + fmt(rNew, 3) + ' %</td>'
               + '<td></td><td></td><td></td><td></td>'
               + '</tr></tbody></table>'
               + '<p class="text-[10px] text-gray-600 font-mono pt-2">r_new = r_T1 * (T2 - T)/(T2 - T1) + r_T2 * (T - T1)/(T2 - T1)</p>'
               + '<p class="text-[10px] text-gray-600 font-mono">'
               + 'r_new = ' + fmt(rT1, 3) + ' * (' + fmt(bracket.T2, 3) + ' - ' + fmt(remainingBindingYears, 3) + ')/(' + fmt(bracket.T2, 3) + ' - ' + fmt(bracket.T1, 3) + ')'
               + ' + ' + fmt(rT2, 3) + ' * (' + fmt(remainingBindingYears, 3) + ' - ' + fmt(bracket.T1, 3) + ')/(' + fmt(bracket.T2, 3) + ' - ' + fmt(bracket.T1, 3) + ')</p>'
               + '</div>';

            row(5, 'Beregnet ny markedsrente', fmt(rNew, 3) + ' %');
            row(6, 'Gjenstående måneder i lånet (n)', n + ' mnd',
                fmt(remainingLoanYears, 2) + ' \u00d7 12 = ' + n + ' (faktisk nedbetalingstid)');
            row(7, 'Terminbeløp med gammel rente', fmtKr(aOld),
                'r_m = ' + fmt(rOld, 3) + '% / 12 = ' + fmt(rmOld, 6)
                + '   A = ' + fmtKr(P) + ' \u00d7 ' + fmt(rmOld, 6)
                + ' / (1 \u2212 (1+' + fmt(rmOld, 6) + ')\u207b' + n + ')');
            row(8, 'Terminbeløp med ny rente', fmtKr(aNew),
                'r_m = ' + fmt(rNew, 3) + '% / 12 = ' + fmt(rmNew, 6)
                + '   A = ' + fmtKr(P) + ' \u00d7 ' + fmt(rmNew, 6)
                + ' / (1 \u2212 (1+' + fmt(rmNew, 6) + ')\u207b' + n + ')');

            h += '<div class="flex justify-between items-baseline py-2.5 border-b border-gray-800/50">'
               + '<span class="text-sm text-gray-300"><span class="text-gray-600 font-mono text-xs mr-2">9.</span>Månedlig differanse (\u0394A)</span>'
               + '<span class="font-mono text-sm font-semibold ' + clr + ' ml-4 text-right shrink-0">' + sign(deltaA) + fmtKr(deltaA) + '/mnd</span>'
               + '</div>'
               + '<p class="text-[10px] text-gray-600 font-mono py-0.5">'
               + fmt(aNew, 2) + ' \u2212 ' + fmt(aOld, 2) + ' = ' + fmt(deltaA, 2) + '</p>';

            row(10, 'Ikke-diskontert total (\u0394A \u00d7 n)', sign(nonDisc) + fmtKr(nonDisc),
                fmt(deltaA, 2) + ' \u00d7 ' + n + ' = ' + fmt(nonDisc, 2));

            h += '<div class="py-3 border-b border-gray-800/50">'
               + '<p class="text-sm text-gray-300 mb-2"><span class="text-gray-600 font-mono text-xs mr-2">11.</span>Diskontert nåverdi (finansavtaleforskriften \u00a7 2-1)</p>'
               + '<div class="bg-gray-800/50 rounded-lg p-4 space-y-2">'
               + '<p class="text-xs text-gray-500 font-mono">NV = \u03a3<sub>t=1</sub><sup>' + n + '</sup> \u0394A / (1 + r<sub>m,ny</sub>)<sup>t</sup></p>'
               + '<p class="text-xs text-gray-500 font-mono">r<sub>m,ny</sub> = ' + fmt(rNew, 3) + '% / 12 = ' + fmt(rmNew, 6) + '</p>'
               + '<p class="text-xs text-gray-600 font-mono mt-1">'
               + '= ' + fmt(deltaA, 2) + '/(1+' + fmt(rmNew, 6) + ')<sup>1</sup>'
               + ' + ' + fmt(deltaA, 2) + '/(1+' + fmt(rmNew, 6) + ')<sup>2</sup>'
               + ' + ' + fmt(deltaA, 2) + '/(1+' + fmt(rmNew, 6) + ')<sup>3</sup>'
               + ' + \u2026 + /(1+' + fmt(rmNew, 6) + ')<sup>' + n + '</sup></p>'
               + '<p class="text-xs text-gray-600 font-mono">'
               + '= ' + fmt(term1, 2) + ' + ' + fmt(term2, 2) + ' + ' + fmt(term3, 2) + ' + \u2026 + ' + fmt(termN, 2) + '</p>'
               + '<p class="text-xl font-mono font-bold ' + clr + ' mt-2">' + sign(npv) + fmtKr(npv) + '</p>'
               + '</div></div>';

            row(12, 'Forskjell (ikke-disk. \u2212 disk.)', fmtKr(diffNonDiscNpv),
                fmt(nonDisc, 2) + ' \u2212 ' + fmt(npv, 2) + ' = ' + fmt(diffNonDiscNpv, 2));

            h += '<div class="py-3 border-b border-gray-800/50">'
               + '<p class="text-sm text-gray-300 mb-2"><span class="text-gray-600 font-mono text-xs mr-2">13.</span>Avvik mot tidligere modell (heuristisk kurve + n = bindingstid \u00d7 12 \u2212 2)</p>'
               + '<table class="w-full text-xs"><tbody>'
               + '<tr class="border-b border-gray-800/30">'
               + '<td class="py-1.5 text-gray-400">Tidligere ny rente</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300">' + fmt(rLegacy, 3) + ' %</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300">\u0394 ' + sign(rateDeviation) + fmt(rateDeviation, 3) + ' pp</td>'
               + '</tr>'
               + '<tr class="border-b border-gray-800/30">'
               + '<td class="py-1.5 text-gray-400">Tidligere n</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300">' + legacyN + ' mnd</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300">\u0394 ' + sign(monthDeviation) + monthDeviation + ' mnd</td>'
               + '</tr>'
               + '<tr class="border-b border-gray-800/30">'
               + '<td class="py-1.5 text-gray-400">Tidligere ikke-diskontert</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300">' + sign(nonDiscLegacy) + fmtKr(nonDiscLegacy) + '</td>'
               + '<td class="py-1.5 text-right font-mono text-gray-300">\u0394 ' + sign(nonDiscDeviation) + fmtKr(nonDiscDeviation) + '</td>'
               + '</tr>'
               + '<tr>'
               + '<td class="py-1.5 text-gray-200 font-semibold">Tidligere diskontert nåverdi</td>'
               + '<td class="py-1.5 text-right font-mono text-white font-semibold">' + sign(npvLegacy) + fmtKr(npvLegacy) + '</td>'
               + '<td class="py-1.5 text-right font-mono text-white font-semibold">\u0394 ' + sign(npvDeviation) + fmtKr(npvDeviation) + '</td>'
               + '</tr>'
               + '</tbody></table>'
               + '<p class="text-[10px] text-gray-600 font-mono pt-2">Nytt oppsett bruker kun to nærmeste fastrentepunkter og amortiserer over faktisk gjenstående løpetid.</p>'
               + '</div>';

            h += '<div class="mt-4 p-4 rounded-lg ' + (pos ? 'bg-emerald-900/30 border border-emerald-800/50' : 'bg-red-900/30 border border-red-800/50') + '">'
               + '<p class="text-sm font-semibold ' + (pos ? 'text-emerald-300' : 'text-red-300') + '">'
               + (pos
                   ? 'Binding nå sparer deg ' + fmtKr(Math.abs(npv)) + ' (nåverdi) over ' + fmt(remainingLoanYears, 2) + ' år'
                   : 'Venting sparer deg ' + fmtKr(Math.abs(npv)) + ' (nåverdi) - neste rente forventes lavere')
               + '</p>'
               + '<p class="text-xs ' + (pos ? 'text-emerald-400/60' : 'text-red-400/60') + ' mt-1">'
               + 'Beregnet iht. finansavtaleforskriften \u00a7 2-1 med månedlig diskontering og faktisk gjenstående løpetid'
               + '</p></div>';

            document.getElementById('modal-title').textContent = 'Detaljert utregning \u2013 Fast ' + tenor;
            document.getElementById('modal-body').innerHTML = h;
            document.getElementById('calc-modal').style.display = 'flex';
        };

        window.closeCalcModal = function() {
            document.getElementById('calc-modal').style.display = 'none';
        };

        if (!window._calcModalEscInit) {
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') closeCalcModal();
            });
            window._calcModalEscInit = true;
        }
    })();
    </script>
    {% else %}
    <p class="text-gray-500 text-sm">Ingen beregninger tilgjengelig</p>
    {% endif %}
</div>
